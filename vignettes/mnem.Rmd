# Simulations

  The following lines of code show an example on how to run simulations in batch on a hpc.
    
		```sh
## how to run in batch:

runnames=("run")

for i in `seq 1 100`; do
    echo ${runnames[$RANDOM % ${#runnames[@]}]}
done

module load repo/grid
module load grid/grid
module load gcc/5.3.0
module load R/3.4.0

for i in `seq 1 10`; do
    file=${runnames[$RANDOM % ${#runnames[@]}]}${i}.sh
    echo "module load repo/grid" >> $file
    echo "module load grid/grid" >> $file
    echo "module load gcc/5.3.0" >> $file
    echo "module load R/3.4.0" >> $file
    echo "R --slave --args 'Sgenes=3' 'run=$i' 'noise=1' 'nem=1:5' < mnem/vignettes/sim.R" >> $file
    qsub -q mpi01.q -pe make 1 $file
    rm $file
done

for i in `seq 1 100`; do
    for j in `seq 1 3`; do
	file=${runnames[$RANDOM % ${#runnames[@]}]}${i}_${j}.sh
	echo "module load repo/grid" >> $file
	echo "module load grid/grid" >> $file
	echo "module load gcc/5.3.0" >> $file
	echo "module load R/3.4.0" >> $file
	echo "R --slave --args 'Sgenes=5' 'run=$i' 'noise=$j' 'nem=1:5' < mnem/vignettes/sim.R" >> $file
	qsub -q mpi04-ht.q -pe make 1 $file
	rm $file
    done
done

for i in `seq 1 100`; do
    for j in `seq 1 3`; do
	for k in `seq 1 5`; do
	    file=${runnames[$RANDOM % ${#runnames[@]}]}${i}_${j}_${k}.sh
	    echo "module load repo/grid" >> $file
	    echo "module load grid/grid" >> $file
	    echo "module load gcc/5.3.0" >> $file
	    echo "module load R/3.4.0" >> $file
	    echo "R --slave --args 'Sgenes=10' 'run=$i' 'noise=$j' 'nem=$k' < mnem/vignettes/sim.R" >> $file
	    qsub -q mpi01.q -pe make 1 $file
	    rm $file
	done
    done
done

rm *.sh.*

## exit
```

# Simulations II

  Another example of simulation not run on a hpc. 

	```r
##library(flexclust)
library(cluster)
library(nem)
library(bnem)
library(epiNEM)
##library(weights)
library(snowfall)
library(Rgraphviz)
library(mnem)
##source("mnem/R/mnems.r")
##source("mnem/R/mnems_low.r")

## random mixture weights simulations:

runs <- 100
maxk <- 5
par(mfrow=c(1,maxk))
mixrand <- matrix(0, runs, maxk)
for (j in 1:5) {
    nem <- j
    tmp <- numeric(runs)
    for (i in 1:runs) {
        mw <- runif(nem, 0.1, 1)
        mw <- mw/sum(mw)
        nem2 <- sample(1:5, 1)
        mw2 <- runif(nem2, 0.1, 1)
        mw2 <- mw2/sum(mw2)
        tmp[i] <- dist(rbind(mw, mw2))
    }
    hist(tmp)
    abline(v=mean(tmp), col = "red")
    abline(v=median(tmp), col = "blue")
    mixrand[, j] <- tmp
}
par(mfrow=c(1,1))

pdf("mixrand.pdf", height = 4, width = 5)
boxplot(mixrand, col = "grey", main = "random", xlab = "components K")
#abline(h=0.5, lty=2)
dev.off()

## variable parameters:
runs <- 10
noises <- c(1, 2.5, 5)
binoises <- c(0.01, 0.1, 0.2, 0.5)

acc <- acc2 <- sens <- spec <- mwcor <- numeric(runs)

Sgenes <- 3
Egenes <- 2
nem <- 2
maxk <- 3
starts <- 10
search <- "modules"
noise <- 1
parallel <- NULL
verbose <- F

doinit <- F
do <- 1
docomps <- TRUE

popSize <- 100
stallMax <- 1

## mixing parameters:
nCells <- 1000#*Sgenes#*nem

dev.off()
par(mfrow=c(1,1))
plot(0, 0, xlim = c(0, length(acc)), ylim = c(0,1))
abline(h=c(0,(1:9)/10,1), lty = 3)

for (run in 1:length(acc)) {
    mw <- runif(nem, 0.1, 1)
    mw <- mw/sum(mw)
    sim <- simData(Sgenes = Sgenes, Egenes = Egenes, nCells = nCells,
                   Nems = nem, uninform = floor(Egenes*Sgenes*0.1), mw = mw)
    simfull <- NULL
    fullsim <- sim$Nem[[1]]*0
    gtn <- list()
    for (i in 1:length(sim$Nem)) {
        tmp <- transitive.closure(sim$Nem[[i]], mat = TRUE)
        simfull <- cbind(simfull, t(tmp))
        fullsim <- fullsim + transitive.closure(sim$Nem[[i]], mat = TRUE)
        gtn[[i]] <- list()
        gtn[[i]]$adj <- sim$Nem[[i]]
    }
    fullsim[which(fullsim > 1)] <- 1
    diag(fullsim) <- 1
    
    data <- sim$data
    data <- (data - 0.5)/0.5
    data <- data + rnorm(length(sim$data), 0, noises[noise])
    for (i in 1:Sgenes) {
        colnames(data)[which(colnames(data) == i)] <- letters[i] # paste("Sgene", i, sep = "")
    }

    init <- list()
    init <- sim$Nem
    theta <- list()
    theta[[1]] <- sim$theta
    p <- matrix(0, nem, ncol(data))
    for (i in 1:nem) {
        p[i, which(sim$index == i)] <- 1
    }
    p <- log2(p)
    
    gtnll <- FALSE
    if (gtnll) {
        gtnll <- mnem(data,
                      max_iter = 0,
                      start = init,
                      p = p
                      )
        print(paste0("GTN ll: ", gtnll$best$ll))
    }
    
    if (!doinit) {
        init <- NULL
        theta <- NULL
        p <- NULL
    }
    start <- Sys.time()
   
    res2 <- list()
    bics <- rep(Inf, maxk)
    for (k in 1:maxk) {
        res2[[k]] <- mnem(data, starts = starts,
                          search = search,
                          start = init,
                          p = p,
                          verbose = verbose,
                          parallel = parallel, k = k
                          )
        bics[k] <- getIC(res2[[k]])
        print(length(res2[[k]]$comp))
    }
    res <- res2[[which.min(bics)]]
    print(bics)
    
    end <- Sys.time()
    print(end - start)
    for (i in 1:length(mw)) {
        lines(run, mw[i], col = 1, type = "b", pch = 1)
    }
    for (i in 1:length(res$mw)) {
        lines(run, res$mw[i], col = 2, type = "b", pch = 2)
    }
    resfull <- NULL
    fullres <- res$comp[[1]]$phi*0
    for (i in 1:length(res$comp)) {
        tmp <- transitive.closure(res$comp[[i]]$phi, mat = TRUE)
        resfull <- cbind(resfull, t(tmp))
        fullres <- fullres + transitive.closure(res$comp[[i]]$phi, mat = TRUE)
    }
    fullres[which(fullres > 1)] <- 1
    diag(fullres) <- 1
    
    tp <- sum(fullres == 1 & fullsim == 1) - ncol(fullres)
    tn <- sum(fullres == 0 & fullsim == 0)
    fp <- sum(fullres == 1 & fullsim == 0)
    fn <- sum(fullres == 0 & fullsim == 1)
    sens[run] <- tp/(tp+fn)
    spec[run] <- tn/(tn+fp)
    acc[run] <- (tp+tn)/(tp+tn+fp+fn)
    resadj <- list()
    for (i in 1:length(res$comp)) {
        resadj[[i]] <- list()
        resadj[[i]]$adj <- res$comp[[i]]$phi
    }
    acc2[run] <- hamSim(resfull, simfull, symmetric = TRUE)
    lines(run, acc2[run], col = 10, type = "b", pch = 3)

    if ((acc[run] < 1 | acc2[run] < 1) & doinit) { stop() }
    randfull <- matrix(sample(c(0,1), Sgenes*Sgenes, replace = TRUE), Sgenes, Sgenes)
    diag(randfull) <- 1
    colnames(randfull) <- rownames(randfull) <- 1:Sgenes
    acc[run] <- hamSim(randfull, simfull, symmetric = TRUE)
    lines(run, acc[run], col = 11, type = "b", pch = 4)
}

```

Evalution of the simulations follows.

```{r, fig.width = 7, fig.height = 7, fig.cap=fig.cap1}

setwd("~/Mount/Grid/") # set the path to the simulation results.

Sgenes <- 20

noises2 <- c(1, 2.5, 5)
nems2 <- 1:10
runs <- 100

simres2 <- array(0, c(runs, length(noises2), length(nems2), 4, 7), list(paste("run_", 1:runs, sep = ""), paste0("noise_", noises2), paste("components_", nems2, sep = ""), c("mnem", "nem", "random", "random2"), c("time", "overfit", "accuracy", "sensitivity", "specificity", "mixing", "mixing2")))

folder <- "temp/"
#folder <- "sim20171129/"

ihaveruns <- ihavenoise <- ihavenems <- NULL

for (run in 1:runs) {
    for (noise in 1:length(noises2)) {
        for (nem in 1:length(nems2)) {
            file <- paste0(folder, "simres_mnem", "_", Sgenes, "_", run, "_", noise, "_", nem, ".rda")
            if (file.exists(file)) {
                ihaveruns <- c(ihaveruns, run)
                ihavenoise <- c(ihavenoise, noise)
                ihavenems <- c(ihavenems, nem)
                load(file)
                simres2[run,noise,nem,,] <- simres2[run,noise,nem,,] + simres[run,noise,nem,,]
            }
        }
    }
}

ihaveruns <- sort(unique(ihaveruns))
ihavenoise <- sort(unique(ihavenoise))
ihavenems <- sort(unique(ihavenems))

simres <- simres2[ihaveruns,,,,] # subset if I don't have all runs...

assign(paste0("simres", Sgenes), simres)
   
noises <- c(1, 2.5, 5)
nems <- 1:10
nems <- nems[ihavenems]

print(ihaveruns)
print(ihavenoise)
print(ihavenems)

## pdf("temp.pdf", width = 12, height = 12)

random <- TRUE

par(mfrow=c(length(nems), 5))
for (l in nems) {
    ylab <- c("seconds", "inferred/simulated components", "accuracy", "sensitivity", "specificity", "mixture weights residuals")
    for (k in 1:7) {
        if (k == 4 | k == 5) { next() }
        tmp <- NULL
        for (i in 4:1) {
            if (i == 3) { next() }
            if (!random & (i == 3 | i == 4)) { next() }
            for (j in 1:length(noises)) {
                restmp <- simres[,j,l,i,k]
                restmp[which(is.nan(restmp) == TRUE)] <- 1
                restmp[which(is.na(restmp) == TRUE)] <- 0
                ## print(x[j])
                tmp <- cbind(tmp, restmp)
            }
        }
        tmp <- tmp[, rev(1:ncol(tmp))]
        for (i in 1:3) {
            tmp[, (i-1)*length(noises)+1:length(noises)] <- tmp[, rev((i-1)*length(noises)+1:length(noises))]
        }
        ## if (k == 1) { tmp <- apply(tmp, c(1,2), function(x) return(log(x+1))) }
        if (k == 2) { tmp <- tmp[, 1:(ncol(tmp)/3)] }
        if (k == 6 | k == 6 | k == 1) {
            minylim <- 0
        } else {
            minylim <- 0#.5
        }
        boxplot(tmp, col = c(rep("grey", length(noises)), rep("lightblue", length(noises)), rep("blue", length(noises))), xaxt = "none", ylim = c(minylim,max(c(1,max(tmp)))), ylab = ylab[k])
        lines(1:ncol(tmp), apply(tmp, 2, mean), type = "p", col = "red", pch = "X")
        if (k == 1) { abline(h=0, lty = 3) }
        if (k == 2) { abline(h=1, lty = 3) }
        if (k != 1 & k != 2) { abline(h=0.5, lty = 3); abline(h=0.9, lty = 3) }
        axis(1, 1:(length(noises)*3), rep(noises, 3))
        axis(1, c(length(noises)/2 + 0.5, length(noises)/2*3 + 0.5, length(noises)/2*5 + 0.5), c("mnem", "nem", "random"), line = 2, tick = FALSE, cex = 2)
        if (k != 2) { abline(v=c(length(noises)+0.5, length(noises)*2+0.5), lty = 3, col = "black", lwd = 2) }
    }
}

dev.off()

## simres <- simresOld

save(simres, file = paste("mnem_sim_", Sgenes, ".rda", sep = ""))

## combine the diff S-genes:

setwd("~/Documents/")

meancol2 <- rgb(1,0,0)

meancol <- rgb(0,0,1)

redcol <- rgb(1,0,0)

bluecol <- rgb(0,0,1)

pdf("sim.pdf", width = 10, height = 8)

mar <- 1.5

par(mfrow=c(5,4),mar=rep(mar, 4),oma=c(3,5,3,0))

for (i in 1:5) {
    for (j in c(3,5,10,20)) {
        tmp <- get(paste0("simres", j))
        tmp2 <- NULL
        for (k in c(1,2)) {
            for (l in 1:3) {
                tmp3 <- tmp[,l,i,k,3]
                #tmp3[which(tmp3 == 0)] <- mean(tmp3[which(tmp3 != 0)])
                tmp2 <- cbind(tmp2, tmp3)
            }
        }
        boxplot(tmp2, col = c(rep(redcol, 3), rep(bluecol, 3), rep("grey", 3)), xaxt = "n", ylim = c(0.5,1))
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol)
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol2, pch = "*")
        axis(1, 1:(length(noises)*3), rep(noises, 3))
        ## axis(1, c(length(noises)/2 + 0.5, length(noises)/2*3 + 0.5, length(noises)/2*5 + 0.5), c("mnem", "nem", "random"), line = 2, tick = FALSE, cex = 2)
        ## abline(v=c(length(noises)+0.5, length(noises)*2+0.5), lty = 3, col = "black", lwd = 2)
        abline(v=c(length(noises)+0.5), lty = 3, col = "black", lwd = 2)
    }
}

for (i in 1:5) {
    mtext(paste0("K=", i), side = 3, line = (40 - (i-1)*11.1), outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*4)
}

Sgenes <- c(3,5,10,20)

for (i in 1:4) {
    mtext(paste0("n=", Sgenes[i]), side = 3, line = 46, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.2 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext("NEM", side = 3, line = 44.3, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(2.97 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext("M&NEM", side = 3, line = 44.3, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.5 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext(expression(sigma), side = 3, line = -12, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.1 - (i-1)*1.2))
}

dev.off()

pdf("sim_g.pdf", width = 10, height = 8)

mar <- 1.5

par(mfrow=c(5,4),mar=rep(mar, 4),oma=c(3,5,3,0))

for (i in 1:5) {
    for (j in c(3,5,10,20)) {
        tmp <- get(paste0("simres", j))
        tmp2 <- NULL
        for (k in c(1,2)) {
            for (l in 1:3) {
                tmp3 <- tmp[,l,i,k,6]
                #tmp3[which(tmp3 == 0)] <- mean(tmp3[which(tmp3 != 0)])
                tmp2 <- cbind(tmp2, tmp3)
            }
        }
        boxplot(tmp2, col = c(rep(redcol, 3), rep(bluecol, 3), rep("grey", 3)), xaxt = "n", ylim = c(0,1))
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol)
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol2, pch = "*")
        axis(1, 1:(length(noises)*3), rep(noises, 3))
        ## axis(1, c(length(noises)/2 + 0.5, length(noises)/2*3 + 0.5, length(noises)/2*5 + 0.5), c("mnem", "nem", "random"), line = 2, tick = FALSE, cex = 2)
        ## abline(v=c(length(noises)+0.5, length(noises)*2+0.5), lty = 3, col = "black", lwd = 2)
        abline(v=c(length(noises)+0.5), lty = 3, col = "black", lwd = 2)
    }
}

for (i in 1:5) {
    mtext(paste0("K=", i), side = 3, line = (40 - (i-1)*11.1), outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*4)
}

Sgenes <- c(3,5,10,20)

for (i in 1:4) {
    mtext(paste0("n=", Sgenes[i]), side = 3, line = 46, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.2 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext("NEM", side = 3, line = 44.3, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(2.97 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext("M&NEM", side = 3, line = 44.3, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.5 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext(expression(sigma), side = 3, line = -12, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.1 - (i-1)*1.2))
}

dev.off()

pdf("sim_k.pdf", width = 10, height = 8)

par(mfrow=c(5,4),mar=rep(mar, 4),oma=c(3,5,3,0))

for (i in 1:5) {
    for (j in c(3,5,10,20)) {
        tmp <- get(paste0("simres", j))
        tmp2 <- NULL
        for (l in 1:3) {
            tmp3 <- tmp[,l,i,1,2]
            #tmp3[which(tmp3 == 0)] <- mean(tmp3[which(tmp3 != 0)])
            tmp2 <- cbind(tmp2, tmp3)
        }
        boxplot(tmp2, col = rep(redcol, 3), xaxt = "n")
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol)
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol2, pch = "*")
        axis(1, 1:(length(noises)*3), rep(noises, 3))
        #axis(1, c(length(noises)/2 + 0.5, length(noises)/2*3 + 0.5, length(noises)/2*5 + 0.5), c(paste0(j, " | ", i), "nem", "random"), line = 2, tick = FALSE, cex = 2)
        ## abline(v=c(length(noises)+0.5, length(noises)*2+0.5), lty = 3, col = "black", lwd = 2)
        abline(h=1, lty = 3, col = "black", lwd = 2)
    }
}

for (i in 1:5) {
    mtext(paste0("K=", i), side = 3, line = (40 - (i-1)*11.1), outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*4)
}

Sgenes <- c(3,5,10,20)

for (i in 1:4) {
    mtext(paste0("n=", Sgenes[i]), side = 3, line = 46, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.2 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext(expression(sigma), side = 3, line = -12, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.15 - (i-1)*1.21))
}

dev.off()

pdf("sim_g1.pdf", width = 10, height = 8)

par(mfrow=c(5,4),mar=rep(mar, 4),oma=c(3,5,3,0))

for (i in 1:5) {
    for (j in c(3,5,10,20)) {
        tmp <- get(paste0("simres", j))
        tmp2 <- NULL
        for (l in 1:3) {
            tmp3 <- tmp[,l,i,1,6]
            #tmp3[which(tmp3 == 0)] <- mean(tmp3[which(tmp3 != 0)])
            tmp2 <- cbind(tmp2, tmp3)
        }
        boxplot(tmp2, col = rep(redcol, 3), xaxt = "n")
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol)
        lines(1:ncol(tmp2), apply(tmp2, 2, mean), type = "p", col = meancol2, pch = "*")
        axis(1, 1:(length(noises)*3), rep(noises, 3))
        #axis(1, c(length(noises)/2 + 0.5, length(noises)/2*3 + 0.5, length(noises)/2*5 + 0.5), c(paste0(j, " | ", i), "nem", "random"), line = 2, tick = FALSE, cex = 2)
        ## abline(v=c(length(noises)+0.5, length(noises)*2+0.5), lty = 3, col = "black", lwd = 2)
        abline(h=1, lty = 3, col = "black", lwd = 2)
    }
}

for (i in 1:5) {
    mtext(paste0("K=", i), side = 3, line = (40 - (i-1)*11.1), outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*4)
}

Sgenes <- c(3,5,10,20)

for (i in 1:4) {
    mtext(paste0("n=", Sgenes[i]), side = 3, line = 46, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.2 - (i-1)*1.2))
}

for (i in 1:4) {
    mtext(expression(sigma), side = 3, line = -12, outer = FALSE, cex = 1, adj = 0,
          at = par("usr")[1] - (par("usr")[2]-par("usr")[1])*(3.15 - (i-1)*1.21))
}

dev.off()

```