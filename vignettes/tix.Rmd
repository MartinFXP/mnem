```sh
## run job

stop()

source activate tix

module load r/3.3.3

## old:

bsub -M 10000 -q normal.4h -n 1 -R "rusage[mem=10000]" "R --slave < mnem/vignettes/tix.r > output.txt"

bsub -M 100000 -W 10 -n 1 -R "rusage[mem=100000]" "R --slave < mnem/vignettes/tix.r > output.txt"

## batch:

for i in {1..225}
do

bsub -M 10000 -q normal.4h -n 1 -e logs/error$i.txt -o logs/output$i.txt -R "rusage[mem=10000]" "R --silent --no-save --args $i < mnem/vignettes/tix.r"

sleep 1
done

##

rm temp.tsv

rm error.txt

rm output.txt

bsub -M 20000 -q normal.24h -n 1 -e error.txt -o output.txt -R "rusage[mem=20000]" "R --silent --no-save --args 1 < mnem/vignettes/tix_run.R"

```

```r

## here comes addtional tix R code, which is not run on any grid:

source("https://bioconductor.org/biocLite.R")

biocLite(c("nem", "graph", "cluster", "snow", "snowfall", "epiNEM", "KEGG.db", "KEGGgraph", "Rgraphviz", "dplyr", "annotables"))

##

source("mnem/R/mnems.r")
source("mnem/R/mnems_low.r")

library(nem)
library(graph)
library(cluster)
library(bnem)
library(snow)
library(snowfall)
library(epiNEM)

library(KEGG.db)
library(KEGGgraph)
library(Rgraphviz)
library(dplyr)
library(annotables)

## get all pathways:

## system("rnai-query select --db /net/bs-filesvr05/export/group/beerenwinkel/simon/data/target_infect_x/data_base/tix.db pathogen > pathogen.tsv")

setwd("~/Mount/Leo/")

## system("rnai-query select --db /cluster/work/bewi/members/simondi/data/tix/database/tix_index.db pathogen > pathogen.tsv")

pathogen <- read.delim("pathogen.tsv", header = FALSE)

pathogen <- as.character(pathogen[, 1])

p <- pathogen[1]

## system("rnai-query select --db /cluster/work/bewi/members/simondi/data/tix/database/tix_index.db gene > genes.tsv")

genes <- read.delim("genes.tsv", header = TRUE)

genes <- toupper(as.character(genes[, 1]))

genes2 <- character(length(genes))

ids <- numeric(length(genes))

count <- 0

for (i in 1:length(genes)) {

    idx <- which(grch38$symbol %in% genes[i])

    if (length(idx) == 0) { next() }

    if (length(idx) > 1) {

        idx <- (idx[!is.na(idx)])[1]

    }

    id <- grch38$entrez[idx]

    ids[count+1] <- id

    genes2[count+1] <- genes[i]

    count <- count + 1

}

genes <- cbind(genes2, ids)

genes <- genes[order(genes[, 1]), ]

genes <- genes[-which(genes[, 2] %in% "0"), ]

genes <- genes[!is.na(genes[, 2]), ]

genes <- genes[!duplicated(genes[, 2]), ]

## save(genes, file = "tix/genes.rda")

load("tix/genes.rda")

kegg <- list()

for (i in genes[, 2]) {
    
    try(kegg[[i]] <- mget(i, KEGGEXTID2PATHID))

}

pathways <- sort(unique(unlist(kegg)))

for (i in pathways) {

    tryres <- try(retrieveKGML(pathwayid=gsub("hsa", "", i), organism="hsa", destfile=paste("tix/pathways/", i, ".xml", sep = ""), method="internal", quiet=TRUE), silent = TRUE)

}

kadj <- list()

count <- 0

for (i in pathways) {

    ## i <- pathways[1]

    if (!file.exists(paste("tix/pathways/", i, ".xml", sep = ""))) { next() }

    keggpw <- parseKGML(paste("tix/pathways/", i, ".xml", sep = ""))
    
    kgraph <- KEGGpathway2Graph(keggpw)
    
    kadjtmp <- graph2adj(kgraph)

    kadjtmp <- kadjtmp[which(gsub("hsa:", "", rownames(kadjtmp)) %in% genes[, 2]), which(gsub("hsa:", "", rownames(kadjtmp)) %in% genes[, 2]), drop = FALSE]

    print(dim(kadjtmp))

    if (dim(kadjtmp)[1] == 1) { next() }

    if (any(kadjtmp == 1)) {
        kadjtmp <- transitive.closure(kadjtmp, mat = TRUE)
    }
    
    diag(kadjtmp) <- 0

    ## I'll do this later:

    ## edgen <- order(apply(kadjtmp, 1, sum)+apply(kadjtmp, 2, sum), decreasing = TRUE)

    ## kadjtmp <- kadjtmp[edgen[1:min(nrow(kadjtmp), 5)], edgen[1:min(nrow(kadjtmp), 5)]]

    kadjtmp <- kadjtmp[order(rownames(kadjtmp)), order(rownames(kadjtmp))]

    rownames(kadjtmp) <- colnames(kadjtmp) <- genes[which(genes[, 2] %in% gsub("hsa:", "", rownames(kadjtmp))), 1]

    count <- count + 1
    
    kadj[[count]] <- kadjtmp

    names(kadj)[count] <- i

    save(kadj, file = "tix/kadj.rda")

}

p <- pathogen[2]

## old but maybe usefull:

## gene ids part II:

genes <- toupper(colnames(scorec)[order(scorec[3, ]*(-scorec[1, ]), decreasing = TRUE)[1:ngenes]])

library("biomaRt")
ensembl=useMart("ensembl")
ensembl = useDataset("hsapiens_gene_ensembl",mart=ensembl)
filters = listFilters(ensembl)
attributes = listAttributes(ensembl)

genesBM <- 
getBM(attributes=c('ensembl_gene_id', 'entrezgene', 'hgnc_symbol', 'hgnc_id'), 
      filters = 'hgnc_symbol', 
      values = genes, 
      mart = ensembl)

genesBM <- genesBM[-which(is.na(genesBM[, 2]) == TRUE), ]

## reactome:

library(org.Hs.eg.db)
library(ReactomePA)
x <- enrichPathway(gene=genes[, 2], pvalueCutoff=0.05, readable=T)
x <- as.data.frame(x)
head(x)

pathways <- unique(sort(x$Description))

viewPathway(pathways[1])
```